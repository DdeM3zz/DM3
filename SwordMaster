local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

-- Настройки
local FOLLOW_DISTANCE = 3
local HEIGHT_OFFSET = 1.5
local ORBIT_RADIUS = 5
local ORBIT_SPEED = 2
local REPEL_FORCE = 300

-- Данные о мечах
local swordsData = {
	{ meshId = "rbxassetid://10444936975", textureId = "rbxassetid://10444937019", offset = Vector3.new(-1.5, 0, 0), scale = Vector3.new(0.15, 0.15, 0.15) },
	{ meshId = "rbxassetid://10455858461", textureId = "rbxassetid://10455858590", offset = Vector3.new(1.5, 0, 0), scale = Vector3.new(0.15, 0.15, 0.15) },
	{ meshId = "rbxassetid _

System: id://10467249177", textureId = "rbxassetid://10467249225", offset = Vector3.new(0, 0.8, 0), scale = Vector3.new(0.15, 0.15, 0.15) }
}

-- Создание меча (локально)
local function createSword(player, data, swordIndex)
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = character.HumanoidRootPart

    local part = Instance.new("Part")
    part.Name = "SwordPart_" .. player.Name .. "_" .. swordIndex
    part.Size = Vector3.new(0.2, 0.2, 0.2)
    part.Anchored = true
    part.CanCollide = false
    part.Transparency = 0
    part.Parent = Workspace

    local mesh = Instance.new("SpecialMesh")
    mesh.MeshType = Enum.MeshType.FileMesh
    mesh.MeshId = data.meshId
    mesh.TextureId = data.textureId
    mesh.Scale = data.scale
    mesh.Parent = part

    return { part = part, offset = data.offset, hrp = hrp }
end

-- GUI
local screenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
screenGui.Name = "ModeSwitchGui"
screenGui.ResetOnSpawn = false

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 300, 0, 100)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -50)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.Active = true
mainFrame.Draggable = true

local frameCorner = Instance.new("UICorner", mainFrame)
frameCorner.CornerRadius = UDim.new(0, 12)

local uiListLayout = Instance.new("UIListLayout", mainFrame)
uiListLayout.FillDirection = Enum.FillDirection.Horizontal
uiListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
uiListLayout.VerticalAlignment = Enum.VerticalAlignment.Center
uiListLayout.Padding = UDim.new(0, 10)

local function createModeButton(modeName, color)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 120, 0, 50)
    btn.BackgroundColor3 = color
    btn.Text = modeName
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 20
    btn.TextColor3 = Color3.new(1, 1, 1)

    local corner = Instance.new("UICorner", btn)
    corner.CornerRadius = UDim.new(0, 8)

    btn.Name = modeName
    return btn
end

local followBtn = createModeButton("Follow", Color3.fromRGB(50, 100, 220))
local orbitBtn = createModeButton("Orbit", Color3.fromRGB(220, 50, 50))
followBtn.Parent = mainFrame
orbitBtn.Parent = mainFrame

-- Логика GUI
local mode = "Follow"
local angleOffset = 0
local playerSwords = {}

local function updateButtons()
    followBtn.BackgroundColor3 = (mode == "Follow") and Color3.fromRGB(50, 150, 250) or Color3.fromRGB(50, 100, 220)
    orbitBtn.BackgroundColor3 = (mode == "Orbit") and Color3.fromRGB(250, 80, 80) or Color3.fromRGB(220, 50, 50)
end

followBtn.MouseButton1Click:Connect(function()
    mode = "Follow"
    updateButtons()
end)

orbitBtn.MouseButton1Click:Connect(function()
    mode = "Orbit"
    updateButtons()
end)

updateButtons()

-- Создание мечей для всех игроков (локально)
for _, player in pairs(Players:GetPlayers()) do
    local swordsList = {}
    for i, data in pairs(swordsData) do
        local sword = createSword(player, data, i - 1)
        if sword then
            table.insert(swordsList, sword)
        end
    end
    playerSwords[player] = swordsList
end

-- Обновление мечей при появлении новых игроков
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        local swordsList = {}
        for i, data in pairs(swordsData) do
            local sword = createSword(player, data, i - 1)
            if sword then
                table.insert(swordsList, sword)
            end
        end
        playerSwords[player] = swordsList
    end)
end)

-- Удаление мечей при выходе игрока
Players.PlayerRemoving:Connect(function(player)
    if playerSwords[player] then
        for _, sword in pairs(playerSwords[player]) do
            if sword.part then
                sword.part:Destroy()
            end
        end
        playerSwords[player] = nil
    end
end)

-- Обновление позиций мечей
RunService.RenderStepped:Connect(function(dt)
    angleOffset += ORBIT_SPEED * dt

    for player, swordsList in pairs(playerSwords) do
        for i, sword in pairs(swordsList) do
            local hrp = sword.hrp
            if not hrp or not hrp.Parent then continue end

            local offset = sword.offset

            if mode == "Follow" then
                local behindPos = hrp.Position - (hrp.CFrame.LookVector * FOLLOW_DISTANCE)
                behindPos += Vector3.new(0, HEIGHT_OFFSET, 0)
                local finalPos = behindPos + hrp.CFrame:VectorToWorldSpace(offset)

                local baseCFrame = CFrame.new(finalPos, finalPos + hrp.CFrame.LookVector)
                local rotatedCFrame = baseCFrame * CFrame.Angles(0, math.rad(90), 0)

                sword.part.CFrame = sword.part.CFrame:Lerp(rotatedCFrame, 0.1)
            else
                local angle = angleOffset + (math.pi * 2 * (i - 1) / 3)
                local orbitPos = hrp.Position + Vector3.new(math.cos(angle) * ORBIT_RADIUS, HEIGHT_OFFSET, math.sin(angle) * ORBIT_RADIUS)
                sword.part.CFrame = CFrame.new(orbitPos)

                for _, otherPlayer in pairs(Players:GetPlayers()) do
                    if otherPlayer ~= player and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
                        local targetHRP = otherPlayer.Character.HumanoidRootPart
                        local dist = (targetHRP.Position - sword.part.Position).Magnitude
                        if dist < 4 then
                            local dir = (targetHRP.Position - sword.part.Position).Unit
                            targetHRP.Velocity += dir * REPEL_FORCE
                        end
                    end
                end
            end
        end
    end
end)
